# CMake build script for protoc-gen-php project
#
# Building (out of source build):
# > mkdir build && cd build
# > cmake .. [-DSETTINGS=VALUE]
# > cmake --build .
#
# Testing:
# > ctest -V
#
# Install:
# > cmake --build . --target install

PROJECT(protoc-gen-php)
CMAKE_MINIMUM_REQUIRED(VERSION 2.8)

# Gtest source archive to use
SET(GTEST_ARCHIVE gtest-1.7.0.zip)
# Where to download archive (if it doesn't exist)
SET(GTEST_DLSERVER http://googletest.googlecode.com/files)
SET(GTEST_ROOT ${CMAKE_CURRENT_BINARY_DIR}/gtest-1.7.0)

INCLUDE(FindProtobuf)
FIND_PACKAGE(Protobuf REQUIRED)
FIND_PACKAGE(Threads)

PROTOBUF_GENERATE_CPP(PHP_OPTIONS_SRCS PHP_OPTIONS_HDRS "php_options.proto")
INCLUDE_DIRECTORIES(
	${PROTOBUF_INCLUDE_DIR}
	${CMAKE_CURRENT_BINARY_DIR}
)

IF(NOT EXISTS ${CMAKE_CURRENT_BINARY_DIR}/${GTEST_ARCHIVE})
	MESSAGE("Downloading file: ${CMAKE_SOURCE_DIR}/${GTEST_ARCHIVE}")
	FILE(DOWNLOAD ${GTEST_DLSERVER}/${GTEST_ARCHIVE}
		${CMAKE_CURRENT_BINARY_DIR}/${GTEST_ARCHIVE})

	EXECUTE_PROCESS(COMMAND cmake -E tar zxf ${GTEST_ARCHIVE}
		WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR})

	ADD_SUBDIRECTORY(${CMAKE_CURRENT_BINARY_DIR}/gtest-1.7.0 gtest-1.7.0)
	INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR}/include ${CMAKE_CURRENT_BINARY_DIR})
ENDIF(NOT EXISTS ${CMAKE_CURRENT_BINARY_DIR}/${GTEST_ARCHIVE})

CONFIGURE_FILE(php_options.proto php_options.proto COPYONLY)
FILE(GLOB SRC_PHP_GEN *.cc)

INCLUDE_DIRECTORIES(${GTEST_ROOT}/include)

ADD_EXECUTABLE(protoc-gen-php ${SRC_PHP_GEN} ${PHP_OPTIONS_SRCS})
TARGET_LINK_LIBRARIES(protoc-gen-php ${PROTOBUF_LIBRARIES})
TARGET_LINK_LIBRARIES(protoc-gen-php ${PROTOBUF_PROTOC_LIBRARY})


ADD_EXECUTABLE(unittest
	tests/unittest.cc protoc-gen-php.cc strutil.cc ${PHP_OPTIONS_SRCS}
)

TARGET_LINK_LIBRARIES(unittest
    pthread
    ${GTEST_ROOT}/build/libgtest.a
    ${GTEST_ROOT}/build/libgtest_main.a
    ${PROTOBUF_LIBRARY}
    ${PROTOBUF_PROTOC_LIBRARY}
)

ENABLE_TESTING()
ADD_TEST(unittest unittest)

INSTALL(TARGETS protoc-gen-php DESTINATION /usr/bin/)
INSTALL(FILES php_options.proto DESTINATION /usr/local/include)


